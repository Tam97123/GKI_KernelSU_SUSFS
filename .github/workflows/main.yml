name: Build Kernels

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release Type"
        type: choice
        options: [ Pre-Release, Release ]
        default: Release
      kernel_variant:
        description: "Choose KernelSU Variant"
        type: choice
        options: [ WILD, NEXT, KSU, SUKI ]
        default: NEXT

jobs:
  build-a12-5-10:
    uses: ./.github/workflows/kernel-a12-5-10.yml
    secrets: inherit
    with:
      kernel_variant: ${{ inputs.kernel_variant }}
  build-a13-5-10:
    uses: ./.github/workflows/kernel-a13-5-10.yml
    secrets: inherit
    with:
      kernel_variant: ${{ inputs.kernel_variant }}

  build-a13-5-15:
    uses: ./.github/workflows/kernel-a13-5-15.yml
    secrets: inherit
    with:
      kernel_variant: ${{ inputs.kernel_variant }}

  build-a14-5-15:
    uses: ./.github/workflows/kernel-a14-5-15.yml
    secrets: inherit
    with:
      kernel_variant: ${{ inputs.kernel_variant }}

  build-a14-6-1:
    uses: ./.github/workflows/kernel-a14-6-1.yml
    secrets: inherit
    with:
      kernel_variant: ${{ inputs.kernel_variant }}

  build-a15-6-6:
    uses: ./.github/workflows/kernel-a15-6-6.yml
    secrets: inherit
    with:
      kernel_variant: ${{ inputs.kernel_variant }}

  build-a16-6-12:
    uses: ./.github/workflows/kernel-a16-612.yml
    secrets: inherit
    with:
      kernel_variant: ${{ inputs.kernel_variant }}

  release:
    runs-on: ubuntu-latest
    needs:
    - build-a12-5-10
    - build-a13-5-10
    - build-a13-5-15
    - build-a14-5-15
    - build-a14-6-1
    - build-a15-6-6
    - build-a16-6-12
    env:
      GH_TOKEN: ${{ github.token }}
      RELEASE_NAME: "GKI Kernels With ${{ inputs.kernel_variant }} & SUSFS ${SUSFS_VERSION}"
      RELEASE_BODY: ""
    steps:

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate New Tag
      if: inputs.release_type != 'Actions'
      run: |
        LATEST_TAG=$(gh api repos/${{ github.repository }}/tags --jq '.[0].name' 2>/dev/null || echo "")
        NEW_TAG=$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')

        echo "New tag: $NEW_TAG"
        echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV

    - name: Set release body
      run: |
        cat << 'EOF' > release_body.md

        **IMPORTANT DISCLAIMER**
        This software is provided for testing and educational purposes only. Use at your own risk.
        The developers are not responsible for any damage, data loss, or issues that may occur.
        Please ensure you have proper backups before installation.

        ðŸ”¹ Bypass 
        - Includes module check bypass modifications 
        - What are kernel modules? Kernel modules are pieces of code that can be loaded into the kernel at runtime to extend functionality (like device drivers, filesystem support, etc.). These are different from KernelSU/Magisk modules. 
        - The Problem: Sometimes when installing a custom kernel, the device tries to load a kernel module that fails due to version mismatches, missing dependencies, or signature verification issues. This can cause boot failures or device instability. 
        - The Solution: This version changes one line from false to true to force load the kernel module, bypassing the failure check that would normally prevent loading.

        Features:
        -> ${{ inputs.kernel_variant }}
        -> Multi Manager Support for WILD, KernelSU-Next! Needs Testing: KSU, MKSU RKSU, xxKSU, KowSU and SukiSU (Best compatibility with WILD, no support will be provided for other managers)
        -> SUSFS à¶ž  ${SUSFS_VERSION}
        -> Scope-Minimized Manual hooks v1.4 for Wild
        -> Ptrace Patch Support for Older Kernels (<5.16)
        -> IPSet Support for Advanced Network Filtering
        -> Wireguard Support
        -> BBR v1 Support
        -> Added BBG support to prevent unauthorised writes to certain partitions: https://github.com/vc-teahouse/Baseband-guard

        ðŸ”¹ BBG (Baseband-guard)
        - A lightweight LSM (Linux Security Module) for Android kernel
        - Blocks unauthorized writes to critical partitions/device nodes
        - Prevents malicious tampering with baseband and boot chain
        - Kernel-level protection via LSM hooks
        - Reduces risk of soft-brick/hard-brick issues

        ðŸ”¹ KPM (KernelPatch Modules):
        - Support for modules that allow you to inject any code into the kernel
        - Provides kernel function inline-hook and syscall-table-hook
          
        ðŸ”¹ ZRAM (Compcache):
        - ZRAM is a Linux kernel module that creates a compressed block device in RAM
        - Instead of swapping data to slow storage (like SSD or eMMC), the kernel compresses data and keeps it in RAM.
        - Because compressed data is smaller, it can fit more â€œvirtual RAMâ€ into the same physical RAM.
        - By add more ZRAM algorithms, kernel has more choice to compress memory data (faster or better)

        Notes:
        -> SUS SU Mode 2 will show as disabled or not compatible due to non-kprobe hooks and is not needed anymore!
        -> Official Kernel Flasher is broken with latest susfs, try https://github.com/fatalcoder524/KernelFlasher/
        -> **boot.img files**: Available as CI artifacts only - download from the Actions tab in the "Misc" Artifact
        -> **Warning**: boot.img files may not boot on some devices
        -> **Note:** For detailed commit information and component versions, please check the build summary in the "Misc" Artifact

        Module: 
        -> [susfs4ksu](https://github.com/sidex15/ksu_module_susfs)

        Managers:
        -> Wild KSU: [Github](https://github.com/WildKernels/Wild_KSU) [Telegram](https://t.me/WildKernels)
        -> KernelSU: [Github](https://github.com/tiann/KernelSU) [Telegram](https://t.me/KernelSU_group)
        -> KernelSU Next: [Github](https://github.com/KernelSU-Next/KernelSU-Next) [Telegram](https://t.me/ksunext_ci)
        -> SukiSU-Ultra: [Github](https://github.com/SukiSU-Ultra/SukiSU-Ultra) [Telegram](https://t.me/Sukiksu)
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.NEW_TAG }}
        prerelease: ${{ inputs.release_type == 'Pre-Release' }}
        files: ""
        name: ${{ env.RELEASE_NAME }}
        body_path: release_body.md

    - name: Download Artifacts
      uses: actions/download-artifact@v5
      with:
        path: ./downloaded-artifacts
        pattern: '*-AnyKernel3'

    - name: Upload Release Assets
      run: |+
        shopt -s nullglob
        anykernel_dirs=(./downloaded-artifacts/*-AnyKernel3/)

        if [ ${#anykernel_dirs[@]} -eq 0 ]; then
          echo "No AnyKernel3 artifact directories found; skipping upload."
          exit 0
        fi

        echo "Found ${#anykernel_dirs[@]} artifacts to process"

        # Create all ZIPs in parallel
        for dir in "${anykernel_dirs[@]}"; do
          artifact_name=$(basename "$dir")
          echo "Creating ZIP for $artifact_name..."
          (cd "$dir" && zip -r -q -9 "$GITHUB_WORKSPACE/${artifact_name}.zip" ./*) &
        done
        wait

        # Upload all ZIPs
        for dir in "${anykernel_dirs[@]}"; do
          artifact_name=$(basename "$dir")
          echo "Uploading ${artifact_name}.zip..."
          gh release upload "${{ env.NEW_TAG }}" "${artifact_name}.zip" --clobber
        done
